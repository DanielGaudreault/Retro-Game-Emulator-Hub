<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>NES Emulator</title>
    <script>
        // Embedded JSNES library (base64-encoded)
        (function() {
            const base64JSNES = "YOUR_BASE64_STRING_HERE"; // Replace with valid base64-encoded jsnes.min.js
            try {
                const script = document.createElement('script');
                script.textContent = atob(base64JSNES);
                document.head.appendChild(script);
                console.log('JSNES embedded script loaded');
            } catch (e) {
                console.error('Failed to decode embedded JSNES:', e);
                alert('Failed to load JSNES library: ' + e.message);
            }
        })();
    </script>
    <style>
        body {
            background: #000;
            display: flex;
            flex-direction: column;
            align-items: center;
            color: #fff;
            font-family: Arial, sans-serif;
            margin: 0;
            padding: 10px;
        }
        canvas {
            background: #000;
            image-rendering: pixelated;
        }
        #status {
            margin-top: 10px;
            font-size: 14px;
        }
        button, input {
            margin: 5px;
            padding: 5px;
        }
    </style>
</head>
<body>
    <canvas id="nesCanvas" width="256" height="240"></canvas>
    <input type="file" id="romFileInput" accept=".nes">
    <button onclick="loadROM()">Load ROM</button>
    <div id="status">No ROM loaded</div>

    <script>
        document.addEventListener('DOMContentLoaded', () => {
            const canvas = document.getElementById('nesCanvas');
            const ctx = canvas.getContext('2d');
            const status = document.getElementById('status');
            let nes;

            // Initialize canvas
            function initCanvas() {
                ctx.fillStyle = '#000';
                ctx.fillRect(0, 0, 256, 240);
                ctx.fillStyle = '#fff';
                ctx.font = '12px Arial';
                ctx.textAlign = 'center';
                ctx.fillText('Load a ROM to begin', 128, 120);
            }
            initCanvas();

            // Check if JSNES is loaded
            if (typeof JSNES === 'undefined') {
                console.error('JSNES not loaded. Embedded script failed.');
                status.textContent = 'Error: JSNES not loaded';
                alert('Failed to load JSNES library. Check the base64 string or try another browser.');
                return;
            }

            // Initialize emulator
            try {
                nes = new JSNES({
                    onFrame: (frameBuffer) => {
                        const imageData = ctx.createImageData(256, 240);
                        for (let i = 0; i < frameBuffer.length; i++) {
                            imageData.data[i * 4 + 0] = (frameBuffer[i] >> 16) & 0xFF; // R
                            imageData.data[i * 4 + 1] = (frameBuffer[i] >> 8) & 0xFF;  // G
                            imageData.data[i * 4 + 2] = frameBuffer[i] & 0xFF;        // B
                            imageData.data[i * 4 + 3] = 255;                          // A
                        }
                        ctx.putImageData(imageData, 0, 0);
                    },
                    onStatusUpdate: (msg) => status.textContent = msg,
                    emulateSound: false // Disable audio for Edge compatibility
                });
                console.log('JSNES emulator initialized');
            } catch (e) {
                console.error('Failed to initialize JSNES:', e);
                status.textContent = 'Error: JSNES initialization failed';
                alert('Failed to initialize JSNES: ' + e.message);
                return;
            }

            // Emulation loop
            function run() {
                if (nes.isRunning) {
                    nes.frame();
                }
                requestAnimationFrame(run);
            }
            requestAnimationFrame(run);

            // Load ROM
            window.loadROM = () => {
                const fileInput = document.getElementById('romFileInput');
                const file = fileInput.files[0];
                if (!file) {
                    alert('Please select a .nes file');
                    status.textContent = 'No ROM selected';
                    return;
                }
                const reader = new FileReader();
                reader.onload = (e) => {
                    try {
                        nes.loadROM(new Uint8Array(e.target.result));
                        status.textContent = `Playing: ${file.name}`;
                        nes.frame();
                        console.log('ROM loaded:', file.name);
                    } catch (error) {
                        console.error('Error loading ROM:', error);
                        alert('Error loading ROM: ' + error.message);
                        status.textContent = 'Error loading ROM';
                        initCanvas();
                    }
                };
                reader.onerror = () => {
                    console.error('Error reading ROM file:', file.name);
                    alert('Error reading ROM file');
                    status.textContent = 'Error reading ROM';
                    initCanvas();
                };
                reader.readAsArrayBuffer(file);
            };

            // Basic controls (ZSNES/FCEUX-like)
            const controls = {
                'ArrowUp': JSNES.Controller.BUTTON_UP,
                'ArrowDown': JSNES.Controller.BUTTON_DOWN,
                'ArrowLeft': JSNES.Controller.BUTTON_LEFT,
                'ArrowRight': JSNES.Controller.BUTTON_RIGHT,
                'z': JSNES.Controller.BUTTON_A,
                'x': JSNES.Controller.BUTTON_B,
                'Enter': JSNES.Controller.BUTTON_START,
                'Shift': JSNES.Controller.BUTTON_SELECT
            };

            document.addEventListener('keydown', (e) => {
                if (controls[e.key]) {
                    nes.buttonDown(1, controls[e.key]);
                    e.preventDefault();
                }
            });

            document.addEventListener('keyup', (e) => {
                if (controls[e.key]) {
                    nes.buttonUp(1, controls[e.key]);
                    e.preventDefault();
                }
            });
        });
    </script>
</body>
</html>
