<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Basic NES Emulator</title>
    <style>
        body {
            background: #000;
            display: flex;
            flex-direction: column;
            align-items: center;
            color: #fff;
            font-family: Arial, sans-serif;
            margin: 0;
            padding: 10px;
        }
        canvas {
            background: #000;
            image-rendering: pixelated;
        }
        #status {
            margin-top: 10px;
            font-size: 14px;
        }
        button, input {
            margin: 5px;
            padding: 5px;
        }
    </style>
</head>
<body>
    <canvas id="nesCanvas" width="256" height="240"></canvas>
    <input type="file" id="romFileInput" accept=".nes">
    <button onclick="loadROM()">Load ROM</button>
    <div id="status">No ROM loaded</div>

    <script>
        document.addEventListener('DOMContentLoaded', () => {
            const canvas = document.getElementById('nesCanvas');
            const ctx = canvas.getContext('2d');
            const status = document.getElementById('status');

            // Initialize canvas
            function initCanvas() {
                ctx.fillStyle = '#000';
                ctx.fillRect(0, 0, 256, 240);
                ctx.fillStyle = '#fff';
                ctx.font = '12px Arial';
                ctx.textAlign = 'center';
                ctx.fillText('Load a ROM to begin', 128, 120);
            }
            initCanvas();

            // Simple ROM parser (iNES format)
            function parseINES(data) {
                try {
                    const header = new Uint8Array(data.slice(0, 16));
                    if (String.fromCharCode(header[0], header[1], header[2], header[3]) !== 'NES\x1A') {
                        throw new Error('Invalid NES file');
                    }
                    const prgSize = header[4] * 16384; // PRG-ROM size (16 KB units)
                    const chrSize = header[5] * 8192;  // CHR-ROM size (8 KB units)
                    const mapper = ((header[6] >> 4) & 0x0F) | (header[7] & 0xF0);
                    if (mapper !== 0) {
                        throw new Error('Only mapper 0 (NROM) supported');
                    }
                    const prgData = new Uint8Array(data.slice(16, 16 + prgSize));
                    return { prgData, chrSize };
                } catch (e) {
                    console.error('ROM parsing error:', e);
                    throw e;
                }
            }

            // Mock frame rendering (simulates PPU output)
            function renderFrame(prgData) {
                ctx.fillStyle = '#000';
                ctx.fillRect(0, 0, 256, 240);
                // Simulate a simple pattern (e.g., display first bytes as pixels)
                for (let i = 0; i < 256 && i < prgData.length; i++) {
                    const value = prgData[i];
                    ctx.fillStyle = value > 128 ? '#fff' : '#555';
                    ctx.fillRect((i % 16) * 16, Math.floor(i / 16) * 16, 16, 16);
                }
            }

            // Load ROM
            window.loadROM = () => {
                const fileInput = document.getElementById('romFileInput');
                const file = fileInput.files[0];
                if (!file) {
                    alert('Please select a .nes file');
                    status.textContent = 'No ROM selected';
                    return;
                }
                const reader = new FileReader();
                reader.onload = (e) => {
                    try {
                        const romData = new Uint8Array(e.target.result);
                        const { prgData } = parseINES(romData);
                        status.textContent = `Playing: ${file.name}`;
                        console.log('ROM loaded:', file.name);
                        renderFrame(prgData); // Mock rendering
                    } catch (error) {
                        console.error('Error loading ROM:', error);
                        alert('Error loading ROM: ' + error.message);
                        status.textContent = 'Error loading ROM';
                        initCanvas();
                    }
                };
                reader.onerror = () => {
                    console.error('Error reading ROM file:', file.name);
                    alert('Error reading ROM file');
                    status.textContent = 'Error reading ROM';
                    initCanvas();
                };
                reader.readAsArrayBuffer(file);
            };

            // Basic controls (mock input handling)
            const controls = {
                'ArrowUp': 'UP',
                'ArrowDown': 'DOWN',
                'ArrowLeft': 'LEFT',
                'ArrowRight': 'RIGHT',
                'z': 'A',
                'x': 'B',
                'Enter': 'START',
                'Shift': 'SELECT'
            };

            document.addEventListener('keydown', (e) => {
                if (controls[e.key]) {
                    console.log(`Button pressed: ${controls[e.key]}`);
                    e.preventDefault();
                }
            });

            document.addEventListener('keyup', (e) => {
                if (controls[e.key]) {
                    console.log(`Button released: ${controls[e.key]}`);
                    e.preventDefault();
                }
            });
        });
    </script>
</body>
</html>
