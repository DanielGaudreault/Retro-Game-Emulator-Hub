<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Minimal NES Emulator</title>
    <script src="./jsnes.min.js" defer></script>
    <script>
        // Fallback to CDN if local script fails
        window.addEventListener('load', () => {
            if (typeof JSNES === 'undefined') {
                console.error('Local jsnes.min.js failed to load. Attempting CDN fallback.');
                const script = document.createElement('script');
                script.src = 'https://cdn.jsdelivr.net/npm/jsnes@1.0.0/dist/jsnes.min.js';
                script.defer = true;
                script.onload = () => console.log('JSNES loaded from CDN');
                script.onerror = () => {
                    console.error('Failed to load JSNES from CDN: https://cdn.jsdelivr.net/npm/jsnes@1.0.0/dist/jsnes.min.js');
                    alert('Failed to load JSNES library from both local and CDN sources. Please check your file setup or internet connection.');
                };
                document.head.appendChild(script);
            } else {
                console.log('JSNES loaded successfully from local file');
            }
        });
    </script>
    <style>
        body {
            background: #000;
            display: flex;
            flex-direction: column;
            align-items: center;
            color: #fff;
            font-family: Arial, sans-serif;
        }
        canvas {
            background: #000;
            image-rendering: pixelated;
        }
        #status {
            margin-top: 10px;
            font-size: 14px;
        }
    </style>
</head>
<body>
    <canvas id="nesCanvas" width="256" height="240"></canvas>
    <input type="file" id="romFileInput" accept=".nes" style="margin: 10px;">
    <button onclick="loadROM()">Load ROM</button>
    <div id="status">No ROM loaded</div>

    <script>
        document.addEventListener('DOMContentLoaded', () => {
            const canvas = document.getElementById('nesCanvas');
            const ctx = canvas.getContext('2d');
            const status = document.getElementById('status');
            let nes;

            // Initialize canvas
            ctx.fillStyle = '#000';
            ctx.fillRect(0, 0, 256, 240);
            ctx.fillStyle = '#fff';
            ctx.font = '12px Arial';
            ctx.textAlign = 'center';
            ctx.fillText('Load a ROM to begin', 128, 120);

            // Check JSNES
            if (typeof JSNES === 'undefined') {
                console.error('JSNES not loaded. Ensure jsnes.min.js is in the same directory or check CDN.');
                status.textContent = 'Error: JSNES not loaded';
                alert('Failed to load JSNES library. Ensure jsnes.min.js is in the project directory or check your internet connection.');
                return;
            }

            // Initialize emulator
            nes = new JSNES({
                onFrame: (frameBuffer) => {
                    const imageData = ctx.createImageData(256, 240);
                    for (let i = 0; i < frameBuffer.length; i++) {
                        imageData.data[i * 4 + 0] = (frameBuffer[i] >> 16) & 0xFF; // R
                        imageData.data[i * 4 + 1] = (frameBuffer[i] >> 8) & 0xFF;  // G
                        imageData.data[i * 4 + 2] = frameBuffer[i] & 0xFF;        // B
                        imageData.data[i * 4 + 3] = 255;                          // A
                    }
                    ctx.putImageData(imageData, 0, 0);
                },
                onStatusUpdate: (msg) => status.textContent = msg
            });

            // Emulation loop
            function run() {
                nes.frame();
                requestAnimationFrame(run);
            }
            requestAnimationFrame(run);

            // Load ROM
            window.loadROM = () => {
                const fileInput = document.getElementById('romFileInput');
                const file = fileInput.files[0];
                if (!file) {
                    alert('Please select a .nes file');
                    return;
                }
                const reader = new FileReader();
                reader.onload = (e) => {
                    try {
                        nes.loadROM(new Uint8Array(e.target.result));
                        status.textContent = `Playing: ${file.name}`;
                        nes.frame();
                    } catch (error) {
                        console.error('Error loading ROM:', error);
                        alert('Error loading ROM: ' + error.message);
                        status.textContent = 'Error loading ROM';
                    }
                };
                reader.onerror = () => {
                    console.error('Error reading ROM file');
                    alert('Error reading ROM file');
                    status.textContent = 'Error reading ROM';
                };
                reader.readAsArrayBuffer(file);
            };

            // Basic controls
            const controls = {
                'ArrowUp': nes.Controller.BUTTON_UP,
                'ArrowDown': nes.Controller.BUTTON_DOWN,
                'ArrowLeft': nes.Controller.BUTTON_LEFT,
                'ArrowRight': nes.Controller.BUTTON_RIGHT,
                'z': nes.Controller.BUTTON_A,
                'x': nes.Controller.BUTTON_B,
                'Enter': nes.Controller.BUTTON_START,
                'Shift': nes.Controller.BUTTON_SELECT
            };

            document.addEventListener('keydown', (e) => {
                if (controls[e.key]) {
                    nes.buttonDown(1, controls[e.key]);
                    e.preventDefault();
                }
            });

            document.addEventListener('keyup', (e) => {
                if (controls[e.key]) {
                    nes.buttonUp(1, controls[e.key]);
                    e.preventDefault();
                }
            });
        });
    </script>
</body>
</html>
