<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>WebNES - Compatible NES Emulator</title>
    <style>
        * {
            margin: 0;
            padding: 0;
            box-sizing: border-box;
            font-family: 'Segoe UI', Tahoma, Geneva, Verdana, sans-serif;
        }

        body {
            background: #1a1a1a;
            color: #e0e0e0;
            overflow: hidden;
        }

        .container {
            display: flex;
            flex-direction: column;
            height: 100vh;
            padding: 20px;
            gap: 20px;
        }

        .header {
            text-align: center;
            padding: 10px;
            background: #2a2a2a;
            border-radius: 8px;
        }

        .header h1 {
            color: #fff;
            font-size: 24px;
        }

        .main-content {
            flex: 1;
            display: flex;
            gap: 20px;
        }

        .game-area {
            flex: 1;
            display: flex;
            flex-direction: column;
            align-items: center;
            gap: 20px;
        }

        .game-screen {
            background: #000;
            border: 4px solid #444;
            border-radius: 8px;
            position: relative;
        }

        #nesCanvas {
            display: block;
            image-rendering: pixelated;
            width: 512px;
            height: 480px;
        }

        .screen-overlay {
            position: absolute;
            top: 0;
            left: 0;
            width: 100%;
            height: 100%;
            background: rgba(0, 0, 0, 0.95);
            display: flex;
            flex-direction: column;
            justify-content: center;
            align-items: center;
            color: white;
            text-align: center;
            padding: 20px;
        }

        .controls {
            display: flex;
            gap: 10px;
            flex-wrap: wrap;
            justify-content: center;
        }

        .btn {
            background: #444;
            border: none;
            color: white;
            padding: 12px 24px;
            cursor: pointer;
            border-radius: 6px;
            font-size: 14px;
            transition: background 0.2s;
        }

        .btn:hover {
            background: #555;
        }

        .btn:disabled {
            background: #333;
            color: #666;
            cursor: not-allowed;
        }

        .btn-primary {
            background: #0078d7;
        }

        .btn-primary:hover {
            background: #106ebe;
        }

        .info-panel {
            width: 400px;
            background: #2a2a2a;
            border-radius: 8px;
            padding: 20px;
        }

        .panel-section {
            margin-bottom: 20px;
        }

        .panel-title {
            color: #fff;
            font-size: 16px;
            margin-bottom: 10px;
            padding-bottom: 5px;
            border-bottom: 1px solid #444;
        }

        .status-item {
            margin-bottom: 8px;
            font-size: 14px;
        }

        .status-value {
            color: #4CAF50;
            font-weight: bold;
        }

        .instructions {
            background: #333;
            padding: 15px;
            border-radius: 6px;
            font-size: 12px;
            line-height: 1.4;
        }

        .key {
            display: inline-block;
            background: #444;
            padding: 2px 6px;
            border-radius: 3px;
            border: 1px solid #666;
            font-family: monospace;
            margin: 2px;
        }

        .message {
            padding: 10px;
            border-radius: 4px;
            margin: 5px 0;
        }

        .message.info {
            background: rgba(33, 150, 243, 0.1);
            border: 1px solid #2196F3;
            color: #64B5F6;
        }

        .message.success {
            background: rgba(76, 175, 80, 0.1);
            border: 1px solid #4CAF50;
            color: #81C784;
        }

        .message.error {
            background: rgba(244, 67, 54, 0.1);
            border: 1px solid #F44336;
            color: #E57373;
        }

        .message.warning {
            background: rgba(255, 152, 0, 0.1);
            border: 1px solid #FF9800;
            color: #FFB74D;
        }

        .rom-info {
            background: #333;
            padding: 10px;
            border-radius: 4px;
            margin: 10px 0;
            font-size: 11px;
            font-family: monospace;
        }

        .test-roms {
            margin: 15px 0;
        }

        .test-rom-btn {
            background: #555;
            border: none;
            color: white;
            padding: 10px 15px;
            cursor: pointer;
            border-radius: 4px;
            font-size: 12px;
            margin: 5px;
            display: block;
            width: 200px;
        }

        .test-rom-btn:hover {
            background: #666;
        }

        .mapper-list {
            max-height: 150px;
            overflow-y: auto;
            background: #333;
            padding: 10px;
            border-radius: 4px;
            font-size: 11px;
        }

        .mapper-item {
            padding: 2px 0;
        }

        .mapper-supported {
            color: #4CAF50;
        }

        .mapper-unsupported {
            color: #F44336;
        }
    </style>
</head>
<body>
    <div class="container">
        <div class="header">
            <h1>üéÆ WebNES - Compatible NES Emulator</h1>
        </div>

        <div class="main-content">
            <div class="game-area">
                <div class="game-screen">
                    <canvas id="nesCanvas" width="256" height="240"></canvas>
                    <div class="screen-overlay" id="screenOverlay">
                        <h2>WebNES Emulator</h2>
                        <p>Load a compatible NES ROM file</p>
                        <div style="margin: 20px 0;">
                            <button class="btn btn-primary" onclick="document.getElementById('romFile').click()">
                                üìÅ Load ROM File
                            </button>
                            <input type="file" id="romFile" accept=".nes" style="display: none;" onchange="loadROM(this.files[0])">
                        </div>
                        <div class="test-roms">
                            <p><strong>Try these compatible ROM types:</strong></p>
                            <button class="test-rom-btn" onclick="showCompatibleGames()">Show Compatible Games</button>
                            <button class="test-rom-btn" onclick="showMapperInfo()">Show Mapper Support</button>
                        </div>
                    </div>
                </div>

                <div class="controls">
                    <button class="btn" onclick="document.getElementById('romFile').click()">
                        Load ROM
                    </button>
                    <button class="btn btn-primary" id="startBtn" onclick="startEmulation()" disabled>
                        Start
                    </button>
                    <button class="btn" id="pauseBtn" onclick="togglePause()" disabled>
                        Pause
                    </button>
                    <button class="btn" id="resetBtn" onclick="resetNES()" disabled>
                        Reset
                    </button>
                </div>

                <div class="instructions">
                    <strong>Tip:</strong> Games with mapper 0 (NROM) work best. Try early NES games like Super Mario Bros.
                </div>
            </div>

            <div class="info-panel">
                <div class="panel-section">
                    <div class="panel-title">Emulator Status</div>
                    <div class="status-item">
                        Status: <span class="status-value" id="status">Ready</span>
                    </div>
                    <div class="status-item">
                        ROM: <span class="status-value" id="romStatus">No ROM loaded</span>
                    </div>
                    <div class="status-item">
                        FPS: <span class="status-value" id="fpsCounter">0</span>
                    </div>
                    <div class="status-item">
                        Mapper: <span class="status-value" id="mapperInfo">Unknown</span>
                    </div>
                </div>

                <div class="panel-section">
                    <div class="panel-title">ROM Information</div>
                    <div id="romInfoArea">
                        <div class="rom-info">No ROM information available</div>
                    </div>
                </div>

                <div class="panel-section">
                    <div class="panel-title">Compatibility</div>
                    <div id="compatibilityInfo">
                        <div class="instructions">
                            JSNES supports limited mappers. Mapper 0 (NROM) works best.
                        </div>
                    </div>
                </div>

                <div class="panel-section">
                    <div class="panel-title">Messages</div>
                    <div id="messageArea">
                        <div class="message info">Load a NES ROM file to begin</div>
                    </div>
                </div>
            </div>
        </div>
    </div>

    <script>
        // NES emulator instance
        let nes = null;
        let emulationRunning = false;
        let animationFrameId = null;
        let frameCount = 0;
        let lastFpsTime = 0;
        let currentFps = 0;
        let currentROM = null;
        let currentMapper = null;

        // DOM elements
        const canvas = document.getElementById('nesCanvas');
        const ctx = canvas.getContext('2d');
        const screenOverlay = document.getElementById('screenOverlay');
        const messageArea = document.getElementById('messageArea');
        const romInfoArea = document.getElementById('romInfoArea');
        const compatibilityInfo = document.getElementById('compatibilityInfo');

        // Key mapping for NES controller
        const KEYMAP = {
            38: 1,  // Arrow Up - UP
            40: 2,  // Arrow Down - DOWN
            37: 4,  // Arrow Left - LEFT
            39: 8,  // Arrow Right - RIGHT
            90: 16, // Z - A
            88: 32, // X - B
            13: 64, // Enter - START
            16: 128 // Shift - SELECT
        };

        // JSNES supported mappers (limited set)
        const SUPPORTED_MAPPERS = {
            0: "NROM (No mapper) - FULLY SUPPORTED",
            1: "MMC1 - PARTIAL SUPPORT",
            2: "UNROM - BASIC SUPPORT", 
            3: "CNROM - BASIC SUPPORT",
            4: "MMC3 - PARTIAL SUPPORT",
            7: "AxROM - BASIC SUPPORT"
        };

        // Games known to work with JSNES
        const COMPATIBLE_GAMES = [
            "Super Mario Bros. (World)",
            "Donkey Kong (World)",
            "Ice Climber (World)",
            "Balloon Fight (World)",
            "Excitebike (World)",
            "Tennis (World)",
            "Golf (World)",
            "Pinball (World)",
            "Clu Clu Land (World)",
            "Wrecking Crew (World)",
            "Donkey Kong Jr. (World)",
            "Mario Bros. (World)",
            "Popeye (World)",
            "10-Yard Fight (World)"
        ];

        // Initialize the NES emulator
        function initNES() {
            try {
                nes = new jsnes.NES({
                    onFrame: function(frameBuffer) {
                        drawFrame(frameBuffer);
                    }
                });
                
                // Draw initial black screen
                ctx.fillStyle = '#000000';
                ctx.fillRect(0, 0, canvas.width, canvas.height);
                
                showMessage('NES emulator initialized successfully', 'success');
                showMessage('Try games with mapper 0 (early NES games)', 'info');
                return true;
            } catch (error) {
                showMessage('Error initializing NES emulator: ' + error.message, 'error');
                return false;
            }
        }

        // Load ROM file with enhanced compatibility checking
        function loadROM(file) {
            if (!file) return;
            
            if (!file.name.toLowerCase().endsWith('.nes')) {
                showMessage('Please select a valid NES ROM file (.nes extension)', 'error');
                return;
            }

            showMessage(`Loading ${file.name}...`, 'info');
            
            const reader = new FileReader();
            reader.onload = function(e) {
                try {
                    const romData = new Uint8Array(e.target.result);
                    
                    // Validate ROM and check compatibility
                    const validation = validateAndCheckCompatibility(romData, file.name);
                    if (!validation.valid) {
                        showMessage(validation.message, 'error');
                        if (validation.suggestion) {
                            showMessage(validation.suggestion, 'warning');
                        }
                        return;
                    }
                    
                    // Initialize emulator if needed
                    if (!nes && !initNES()) {
                        return;
                    }
                    
                    // Try to load the ROM
                    try {
                        nes.loadROM(romData);
                        currentROM = file.name;
                        currentMapper = validation.info.mapper;
                        
                        document.getElementById('romStatus').textContent = file.name;
                        document.getElementById('mapperInfo').textContent = `Mapper ${currentMapper}`;
                        document.getElementById('startBtn').disabled = false;
                        document.getElementById('resetBtn').disabled = false;
                        
                        updateRomInfo(validation.info);
                        updateCompatibilityInfo(validation.info.mapper);
                        
                        if (validation.info.mapper === 0) {
                            showMessage('‚úÖ ROM loaded! This should work well. Click "Start" to play.', 'success');
                        } else {
                            showMessage('‚ö†Ô∏è ROM loaded but may have issues. Mapper ' + validation.info.mapper + ' has limited support.', 'warning');
                            showMessage('Click "Start" to try running the game.', 'info');
                        }
                        
                    } catch (loadError) {
                        showMessage('ROM loading failed: ' + loadError.message, 'error');
                        if (currentMapper !== 0) {
                            showMessage('Try finding a ROM with mapper 0 (NROM)', 'warning');
                        }
                    }
                    
                } catch (error) {
                    showMessage('Error processing ROM: ' + error.message, 'error');
                }
            };
            
            reader.onerror = function() {
                showMessage('Error reading file', 'error');
            };
            
            reader.readAsArrayBuffer(file);
        }

        // Enhanced validation with compatibility checking
        function validateAndCheckCompatibility(romData, filename) {
            if (romData.length < 16) {
                return {
                    valid: false,
                    message: 'File too small to be a valid NES ROM',
                    suggestion: 'Try a different ROM file'
                };
            }
            
            // Check for iNES header
            const header = new TextDecoder().decode(romData.slice(0, 4));
            const isINES = header === 'NES\x1A';
            
            if (!isINES) {
                return {
                    valid: false,
                    message: 'Not a valid iNES ROM file (missing NES header)',
                    suggestion: 'This may be a corrupted or non-standard ROM'
                };
            }
            
            // Extract ROM information
            const prgRomSize = romData[4] * 16 * 1024;
            const chrRomSize = romData[5] * 8 * 1024;
            const flags6 = romData[6];
            const flags7 = romData[7];
            const mapper = (flags7 & 0xF0) | (flags6 >> 4);
            
            const info = {
                filename: filename,
                size: romData.length,
                prgRomSize: prgRomSize,
                chrRomSize: chrRomSize,
                mapper: mapper,
                flags6: flags6,
                flags7: flags7
            };
            
            // Check mapper support
            if (!SUPPORTED_MAPPERS[mapper]) {
                return {
                    valid: false,
                    message: `Mapper ${mapper} is not supported by this emulator`,
                    suggestion: 'Try finding a ROM that uses mapper 0 (NROM)',
                    info: info
                };
            }
            
            // Check for potential issues
            let warnings = [];
            if (mapper !== 0) {
                warnings.push(`Mapper ${mapper} has limited support`);
            }
            if (flags6 & 4) { // Trainer present
                warnings.push('ROM contains trainer data - may cause issues');
            }
            
            return {
                valid: true,
                message: `Valid ROM detected - ${SUPPORTED_MAPPERS[mapper]}`,
                info: info,
                warnings: warnings
            };
        }

        // Update ROM information display
        function updateRomInfo(info) {
            let html = `
                <div><strong>File:</strong> ${info.filename}</div>
                <div><strong>Size:</strong> ${(info.size / 1024).toFixed(1)} KB</div>
                <div><strong>PRG ROM:</strong> ${(info.prgRomSize / 1024).toFixed(1)} KB</div>
                <div><strong>CHR ROM:</strong> ${(info.chrRomSize / 1024).toFixed(1)} KB</div>
                <div><strong>Mapper:</strong> ${info.mapper}</div>
                <div><strong>Support:</strong> ${SUPPORTED_MAPPERS[info.mapper] || 'UNSUPPORTED'}</div>
            `;
            
            romInfoArea.innerHTML = html;
        }

        // Update compatibility information
        function updateCompatibilityInfo(mapper) {
            let html = '';
            
            if (mapper === 0) {
                html = '<div class="message success">‚úÖ This ROM should work perfectly!</div>';
            } else if (SUPPORTED_MAPPERS[mapper]) {
                html = `<div class="message warning">‚ö†Ô∏è ${SUPPORTED_MAPPERS[mapper]}</div>`;
            } else {
                html = '<div class="message error">‚ùå Mapper not supported</div>';
            }
            
            compatibilityInfo.innerHTML = html;
        }

        // Show compatible games list
        function showCompatibleGames() {
            let html = '<div class="panel-title">Known Compatible Games</div>';
            html += '<div class="mapper-list">';
            COMPATIBLE_GAMES.forEach(game => {
                html += `<div class="mapper-item mapper-supported">‚úÖ ${game}</div>`;
            });
            html += '</div>';
            html += '<div class="instructions" style="margin-top: 10px;">These games use mapper 0 and should work well.</div>';
            
            compatibilityInfo.innerHTML = html;
        }

        // Show mapper support information
        function showMapperInfo() {
            let html = '<div class="panel-title">Mapper Support</div>';
            html += '<div class="mapper-list">';
            Object.keys(SUPPORTED_MAPPERS).forEach(mapper => {
                const supportLevel = mapper === '0' ? 'mapper-supported' : 'mapper-unsupported';
                html += `<div class="mapper-item ${supportLevel}">Mapper ${mapper}: ${SUPPORTED_MAPPERS[mapper]}</div>`;
            });
            html += '</div>';
            html += '<div class="instructions" style="margin-top: 10px;">Mapper 0 (NROM) has the best support.</div>';
            
            compatibilityInfo.innerHTML = html;
        }

        // Start emulation
        function startEmulation() {
            if (!nes || !currentROM) {
                showMessage('No ROM loaded', 'error');
                return;
            }
            
            if (emulationRunning) return;
            
            emulationRunning = true;
            screenOverlay.style.display = 'none';
            updateStatus('Running');
            
            if (currentMapper === 0) {
                showMessage('üéÆ Emulation started! Game should be working.', 'success');
            } else {
                showMessage('üéÆ Emulation started! Game may have graphical or gameplay issues.', 'warning');
            }
            
            // Start the emulation loop
            lastFpsTime = performance.now();
            frameCount = 0;
            animationFrameId = requestAnimationFrame(emulationLoop);
        }

        // Main emulation loop
        function emulationLoop(timestamp) {
            if (!emulationRunning) return;
            
            try {
                // Run NES frame
                nes.frame();
                
                // Update counters
                frameCount++;
                updateFPS(timestamp);
                
                // Continue the loop
                animationFrameId = requestAnimationFrame(emulationLoop);
                
            } catch (error) {
                console.error('Emulation error:', error);
                showMessage('Emulation error: ' + error.message, 'error');
                stopEmulation();
            }
        }

        // Draw frame from NES frame buffer
        function drawFrame(frameBuffer) {
            const imageData = ctx.createImageData(256, 240);
            
            for (let i = 0; i < frameBuffer.length; i++) {
                const pixel = frameBuffer[i];
                const baseIndex = i * 4;
                
                imageData.data[baseIndex] = (pixel >> 16) & 0xFF;
                imageData.data[baseIndex + 1] = (pixel >> 8) & 0xFF;
                imageData.data[baseIndex + 2] = pixel & 0xFF;
                imageData.data[baseIndex + 3] = 255;
            }
            
            ctx.putImageData(imageData, 0, 0);
        }

        // Toggle pause
        function togglePause() {
            if (!emulationRunning) return;
            
            emulationRunning = !emulationRunning;
            
            if (emulationRunning) {
                animationFrameId = requestAnimationFrame(emulationLoop);
                updateStatus('Running');
                showMessage('Emulation resumed', 'success');
                document.getElementById('pauseBtn').textContent = 'Pause';
            } else {
                if (animationFrameId) cancelAnimationFrame(animationFrameId);
                updateStatus('Paused');
                showMessage('Emulation paused', 'info');
                document.getElementById('pauseBtn').textContent = 'Resume';
            }
        }

        // Reset NES
        function resetNES() {
            if (nes && currentROM) {
                nes.reset();
                showMessage('NES reset', 'info');
            }
        }

        // Stop emulation
        function stopEmulation() {
            emulationRunning = false;
            if (animationFrameId) {
                cancelAnimationFrame(animationFrameId);
                animationFrameId = null;
            }
            updateStatus('Stopped');
        }

        // Update FPS counter
        function updateFPS(timestamp) {
            if (timestamp - lastFpsTime >= 1000) {
                currentFps = Math.round((frameCount * 1000) / (timestamp - lastFpsTime));
                frameCount = 0;
                lastFpsTime = timestamp;
                document.getElementById('fpsCounter').textContent = currentFps;
            }
        }

        // Update status
        function updateStatus(status) {
            document.getElementById('status').textContent = status;
        }

        // Show message
        function showMessage(message, type = 'info') {
            const messageDiv = document.createElement('div');
            messageDiv.className = `message ${type}`;
            messageDiv.textContent = message;
            messageArea.insertBefore(messageDiv, messageArea.firstChild);
            
            while (messageArea.children.length > 5) {
                messageArea.removeChild(messageArea.lastChild);
            }
        }

        // Initialize when page loads
        window.addEventListener('load', function() {
            if (initNES()) {
                showMessage('üéÆ WebNES Emulator ready!', 'success');
                showMessage('Look for games that use mapper 0 (early NES titles)', 'info');
                showMapperInfo();
            }
            setupKeyboard();
        });

        // Setup keyboard controls
        function setupKeyboard() {
            document.addEventListener('keydown', function(e) {
                if (!nes || !emulationRunning) return;
                const button = KEYMAP[e.keyCode];
                if (button !== undefined) {
                    e.preventDefault();
                    nes.buttonDown(1, button);
                }
            });

            document.addEventListener('keyup', function(e) {
                if (!nes || !emulationRunning) return;
                const button = KEYMAP[e.keyCode];
                if (button !== undefined) {
                    e.preventDefault();
                    nes.buttonUp(1, button);
                }
            });
        }

        // Handle page visibility
        document.addEventListener('visibilitychange', function() {
            if (document.hidden && emulationRunning) {
                stopEmulation();
                showMessage('Emulation paused (tab inactive)', 'info');
            }
        });

        // Prevent default behavior for game keys
        document.addEventListener('keydown', function(e) {
            if ([38, 40, 37, 39, 90, 88, 13, 16].includes(e.keyCode)) {
                e.preventDefault();
            }
        });
    </script>
</body>
</html>
